---
ocean:
  version: "1"
snapshots:
  - name: dask
    registry: docker_hub
    image: jupyter/scipy-notebook
    tag: latest
steps:
  - engines:
    - name: dask_scheduler
      vars:
        - name: private_ip
          value: "{{ engines.dask_scheduler.deployment.nodes.main.private_ip }}"
        - name: port
          value: "{% reserve_public_port %}"
        - name: dashboard_port
          value: "{% reserve_public_port %}"
        - name: url
          value: "tcp://{{ engines.dask_scheduler.vars.private_ip }}:{{ engines.dask_scheduler.vars.port }}"
      orchestrator:
        deployment_strategy: main
        snapshot_name: dask
        container:
          user: root
          workdir: /work
          mounts:
            app_files:
              - name: dask_scheduler
                app_files_path: dask_scheduler
                container_path: /ocean/etc/dask_scheduler
                readonly: true
            data_stores: "{{ engines.dask_scheduler.orchestrator.container.workdir }}"
            ssh: "/home/{{ workspace.user.name }}/.ssh"
          nodes:
            main:
              command: "{{ engines.dask_scheduler.orchestrator.container.mounts.app_files.dask_scheduler.container_path }}/startup.sh"
      ui:
        buttons:
          - node_target: main
            label: Dask Scheduler Dashboard
            url: "http://{{ engines.dask_scheduler.ui.buttons.self.node.public_ip }}:{{ engines.dask_scheduler.vars.dashboard_port }}"
  - engines:
    - name: jupyter
      vars:
        - name: port
          value: "{% reserve_public_port %}"
        - name: token
          value: "{% generate_uuid %}"
      orchestrator:
        deployment_strategy: main
        snapshot_name: dask
        container:
          user: root
          workdir: /work
          mounts:
            app_files:
              - name: jupyter
                app_files_path: jupyter
                container_path: /ocean/etc/jupyter
                readonly: true
            data_stores: "{{ engines.jupyter.orchestrator.container.workdir }}"
            ssh: "/home/{{ workspace.user.name }}/.ssh"
          nodes:
            main:
              command: "{{ engines.jupyter.orchestrator.container.mounts.app_files.jupyter.container_path }}/startup.sh"
              env_vars:
                - name: JUPYTER_ENABLE_LAB
                  value: "yes"
                - name: NB_UID
                  value: "{{ workspace.user.uid }}"
                - name: NB_GID
                  value: "{{ workspace.user.gid }}"
                - name: CHOWN_HOME
                  value: "yes"
                - name: GRANT_SUDO
                  value: "yes"
                - name: RESTARTABLE
                  value: "yes"
                - name: DASK_SCHEDULER
                  value: "{{ engines.dask_scheduler.vars.url }}"
      ui:
        buttons:
          - node_target: main
            label: Jupyter Notebook
            url: "http://{{ engines.jupyter.ui.buttons.self.node.public_ip }}:{{ engines.jupyter.vars.port }}?token={{ engines.jupyter.vars.token }}"
    - name: dask_worker
      vars:
        - name: port
          value: "{% reserve_private_port %}"
        - name: nanny_port
          value: "{% reserve_private_port %}"
        - name: dashboard_port
          value: "{% reserve_public_port %}"
      orchestrator:
        deployment_strategy: workers_fill_pool
        snapshot_name: dask
        container:
          user: root
          workdir: /work
          mounts:
            app_files:
              - name: dask_worker
                app_files_path: dask_worker
                container_path: /ocean/etc/dask_worker
                readonly: true
            data_stores: "{{ engines.dask_worker.orchestrator.container.workdir }}"
            ssh: "/home/{{ workspace.user.name }}/.ssh"
          nodes:
            worker:
              command: "{{ engines.dask_worker.orchestrator.container.mounts.app_files.dask_worker.container_path }}/startup.sh"
      ui:
        buttons:
          - node_target: workers
            label: Dask Worker Dashboard
            url: "http://{{ engines.dask_worker.ui.buttons.self.node.public_ip }}:{{ engines.dask_worker.vars.dashboard_port }}"